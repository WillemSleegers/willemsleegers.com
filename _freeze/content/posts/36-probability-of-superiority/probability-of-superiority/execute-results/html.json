{
  "hash": "6719dd232058c632eb1969c45ab5d3b4",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Probability of superiority\"\ndescription: \"The probability of superiority is, according to some, a more intuitive effect size measure than other more commonly reported effect sizes. In this blog post I work through some code to calculate the probabily of superiority. \"\ndate: 2024-03-20\ncategories:\n  - statistics\n  - effect size\n  - probability of superiority\ncode-tools: true\ncode-fold: show\ndraft: true\n---\n\n\nThe probability of superiority for a comparison between two groups is the probability that, when sampling an observation from each of the groups at random, the observation from the second group will be larger than the sample from the first group. It ranges from 0 to 1 (because it's a probability), where 0.5 means there is no difference between the two groups.\n\nAn advantage of the probability of superiority, I'll shorten it to p-sup, is that it's more easily understood than something like a Cohen's d. There are still some limitations (e.g., see some discussed [here](https://statmodeling.stat.columbia.edu/2023/08/16/confusions-about-inference-prediction-and-probability-of-superiority/)), but I think overall it's an interesting effect size and I should use it more often.\n\nSo, in this blog post I'll figure out how to calculate it.\n\nRun the following setup code if you want to follow along.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(effectsize)\nlibrary(RProbSup)\nlibrary(brms)\nlibrary(tidybayes)\nlibrary(scales)\n\ndata <- read_csv(\"data.csv\")\ndata <- drop_na(data)\n\noptions(\n  mc.cores = 4,\n  brms.threads = 4,\n  brms.backend = \"cmdstanr\",\n  brms.file_refit = \"on_change\"\n)\n\ntheme_set(theme_minimal())\ncolors <- c(\"#d1e1ec\", \"#b3cde0\", \"#6497b1\", \"#005b96\", \"#03396c\", \"#011f4b\")\n```\n:::\n\n\n## Manually calculating p-sup\n\nLet's manually calculate p-sup with some simple data. In the code block below I create two variables containing some data; one per group. I'll also store the length of one of them in a variable because we'll use it later.\n\n\n::: {.cell}\n\n```{.r .cell-code}\na <- c(2, 3, 4, 5, 6)\nb <- c(1, 2, 3, 4, 5)\n\nn <- length(a)\n```\n:::\n\n\nWith these two groups of data we want to calculate p-sup. The steps needed consist of making all pairwise comparisons between members of each group, tallying the number of times that the former scores are higher than the latter (incrementing by 0.5 if they are tied), and dividing by the total number of comparisons that were made (also see [Ruscio, 2008](https://doi.org/10.1037/1082-989X.13.1.19)).\n\nLet's do this step by step and start with making all pairwise comparisons. We can do that using the `outer()` function. We give it two sets of data and tell it which comparison to make. In the code below we have it check whether values in `a` are higher than values in `b`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nouter(a, b, \">\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     [,1]  [,2]  [,3]  [,4]  [,5]\n[1,] TRUE FALSE FALSE FALSE FALSE\n[2,] TRUE  TRUE FALSE FALSE FALSE\n[3,] TRUE  TRUE  TRUE FALSE FALSE\n[4,] TRUE  TRUE  TRUE  TRUE FALSE\n[5,] TRUE  TRUE  TRUE  TRUE  TRUE\n```\n\n\n:::\n:::\n\n\nThe output is a matrix with the outcomes of each comparison (`TRUE`, `FALSE`), where the rows represent values from `a` and the columns values from `b`. For example, the result in row 1 and column 1 is `TRUE`, because the first element of `a` (2) is larger than the first element of `b` (1). Another example, the result in row 1 column 2 is `FALSE` because the first element of `a` (2) is not larger than the second element of `b` (2), it's a tie.\n\nNext, we need to count the number of times that an element in `a` is larger than an element in `b`. This is easily done by using `sum()` on the matrix. This works because `TRUE` is treated as 1 and `FALSE` as 0.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(outer(a, b, \">\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 15\n```\n\n\n:::\n:::\n\n\nTo deal with ties, we count the number of times a tie happens and divide the sum by 2, thereby saying that ties are treated as one value being larger than the other half the time.\n\nBoth of the sums are summed together, giving us:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(sum(outer(a, b, \">\")) + 0.5 * sum(outer(a, b, \"==\")))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 17\n```\n\n\n:::\n:::\n\n\nThis is actually the same thing as the Wilcoxon (or Mann-Whitney) test statistic.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwilcox.test(a, b)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tWilcoxon rank sum test with continuity correction\n\ndata:  a and b\nW = 17, p-value = 0.3976\nalternative hypothesis: true location shift is not equal to 0\n```\n\n\n:::\n:::\n\n\nDividing this number by the total number of comparisons gives us the probability of superiority.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(sum(outer(a, b, \">\")) + 0.5 * sum(outer(a, b, \"==\"))) / (n * n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.68\n```\n\n\n:::\n:::\n\n\nLet's turn this into a function and then compare the result to what we get when we use some ready-made functions from various packages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_sup <- function(a, b) {\n  # Count number of times a > b\n  sum <- sum(outer(a, b, \">\"))\n\n  # Count ties, counting each tie as a half\n  ties <- sum(outer(a, b, \"==\")) * 0.5\n\n  # Sum both and divide by total number of comparisons\n  p_sup <- (sum + ties) / (length(a) * length(b))\n\n  return(p_sup)\n}\n\ndf <- cbind(c(a, b), c(rep(\"a\", 5), rep(\"b\", 5)))\n\ntribble(\n  ~package, ~code, ~p_sup,\n  \"-\", \"p_sup(a, b)\", p_sup(a, b),\n  \"effectsize\",\n  \"p_superiority(a, b, parametric = FALSE)\",\n  p_superiority(a, b, parametric = FALSE)$p_superiority,\n  \"RProbSup\", \"A(df, 1, 2)\", A(df, 1, 2)$A\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 × 3\n  package    code                                    p_sup\n  <chr>      <chr>                                   <dbl>\n1 -          p_sup(a, b)                              0.68\n2 effectsize p_superiority(a, b, parametric = FALSE)  0.68\n3 RProbSup   A(df, 1, 2)                              0.68\n```\n\n\n:::\n:::\n\n\n## A Frequentist example\n\nLet's take a look at a real-life example by calculating p-sup using real data. I found some data from the LISS panel on how important people think animal rights are. I added the participant's sex to the data so we can take a look at sex differences on this outcome.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprops <- data |>\n  group_by(sex) |>\n  count(importance_animal_rights) |>\n  mutate(prop = n / sum(n))\n\nggplot(props, aes(x = importance_animal_rights, y = prop, fill = sex)) +\n  geom_col(position = \"dodge\", alpha = .8) +\n  scale_x_continuous(breaks = 1:7) +\n  scale_y_continuous(labels = percent_format()) +\n  scale_fill_manual(values = c(colors[2], colors[5])) +\n  labs(x = \"Importance of animal rights\", y = \"Percentage\", fill = \"\")\n```\n\n::: {.cell-output-display}\n![](probability-of-superiority_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nLet's calculate p-sup using our function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_sup(\n  pull(filter(data, sex == \"Female\"), importance_animal_rights),\n  pull(filter(data, sex == \"Male\"), importance_animal_rights)\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.5849741\n```\n\n\n:::\n:::\n\n\nAnd the function from the effectsize package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_superiority(importance_animal_rights ~ sex, data = data, parametric = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPr(superiority) |       95% CI\n------------------------------\n0.58            | [0.57, 0.60]\n\n- Non-parametric CLES\n```\n\n\n:::\n:::\n\n\n## A Bayesian example\n\nWe can analyze the same data using a Bayesian model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel <- brm(\n  importance_animal_rights ~ sex,\n  data = data, file = \"model.Rds\"\n)\n\ndraws <- data |>\n  add_predicted_draws(model, value = \"predicted_outcome\")\n\np_sups <- draws |>\n  group_by(.draw) |>\n  summarize(\n    p_sup = p_superiority(\n      predicted_outcome ~ sex,\n      parametric = FALSE\n    )$p_superiority\n  )\n\nmedian_qi(p_sups, p_sup)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 6\n  p_sup .lower .upper .width .point .interval\n  <dbl>  <dbl>  <dbl>  <dbl> <chr>  <chr>    \n1 0.589  0.569  0.609   0.95 median qi       \n```\n\n\n:::\n:::",
    "supporting": [
      "probability-of-superiority_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}